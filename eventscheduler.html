<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Event Scheduler - Editor</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@500&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <div class="container glass-effect">
        <header class="header">
            <h1><i data-lucide="calendar-clock"></i> Event Scheduler</h1>
            <p>Schedule and configure recurring server events for MuOnline Season 19.</p>
        </header>

        <main class="editor-grid">
            <section class="panel">
                <h2>Event List</h2>
                <p>Load, create, and edit scheduled events. Events reference data files under <code>data/Event/</code> and <code>data/</code> maps.</p>
                <div id="event-list" class="list">
                    <!-- Event rows will be populated by client JS -->
                </div>
                <div class="panel-actions">
                    <button id="new-event">New Event (creates Event.ini entry)</button>
                </div>
            </section>

            <section class="panel">
                <h2>Event Details</h2>
                <div style="display:flex;gap:12px;align-items:center;">
                    <div style="flex:1;min-width:220px;">
                        <label for="file-select">Select file</label>
                        <select id="file-select" style="min-width:220px"></select>
                        <button id="load-file">Load</button>
                    </div>
                    <div style="flex:1"> 
                        <div><strong>Parsed Header</strong></div>
                        <div id="parsed-header" style="white-space:pre-wrap; background:#fff2; padding:8px; border-radius:4px; min-height:60px; max-height:160px; overflow:auto;"></div>
                    </div>
                </div>
                <div style="margin-top:12px;">
                    <label>Raw Content (editable)</label>
                    <textarea id="event-raw" rows="18" style="width:100%" placeholder="Event file content will appear here."></textarea>
                </div>
                <div class="panel-actions" style="margin-top:8px;">
                    <button id="apply-header">Apply Edited Header To Raw</button>
                    <button id="save-file">Save File</button>
                    <button id="save-as">Save As...</button>
                </div>
            </section>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();

            async function loadOverview() {
                try {
                    const res = await fetch('/api/event-data');
                    if (!res.ok) return;
                    const data = await res.json();

                    const list = document.getElementById('event-list');
                    list.innerHTML = '';

                    if (data.eventIni) {
                        const preview = document.createElement('pre');
                        preview.textContent = data.eventIni.split('\n').slice(0, 30).join('\n');
                        list.appendChild(preview);
                    } else {
                        const info = document.createElement('div');
                        info.textContent = 'No Event.ini present — available files listed below.';
                        list.appendChild(info);
                    }

                    // File selector
                    const select = document.getElementById('file-select');
                    select.innerHTML = '';
                    (data.files || []).forEach(f => {
                        const opt = document.createElement('option');
                        opt.value = f;
                        opt.textContent = f;
                        select.appendChild(opt);
                    });

                    if (!Array.isArray(data.files) || !data.files.includes('Event.ini')) {
                        const opt = document.createElement('option');
                        opt.value = 'Event.ini';
                        opt.textContent = 'Event.ini';
                        select.insertBefore(opt, select.firstChild);
                    }

                    const meta = document.createElement('div');
                    meta.style.marginTop = '8px';
                    meta.innerHTML = `<strong>Dirs:</strong> ${(data.dirs || []).join(', ')}`;
                    list.appendChild(meta);

                } catch (err) {
                    console.warn('Could not load event data', err);
                }
            }

            async function loadFile(filename) {
                try {
                    if (filename === 'Event.ini') {
                        const res = await fetch('/api/event-data');
                        const data = await res.json();
                        document.getElementById('event-raw').value = data.eventIni || '';
                        document.getElementById('parsed-header').textContent = JSON.stringify(parsePreview(data.fileDetails || []), null, 2);
                        return;
                    }
                    // Fetch parsed file data
                    const res = await fetch(`/api/event-file?filename=${encodeURIComponent(filename)}&parse=1`);
                    if (res.ok) {
                        const json = await res.json();
                        document.getElementById('event-raw').value = json.raw || json.body || '';
                        document.getElementById('parsed-header').textContent = JSON.stringify(json.parsed || {}, null, 2);
                    } else {
                        document.getElementById('event-raw').value = '';
                        document.getElementById('parsed-header').textContent = '';
                    }
                } catch (err) {
                    console.warn('Could not load file', err);
                }
            }

            async function saveFile(filename, content) {
                try {
                    const body = { filename: filename === 'Event.ini' ? undefined : filename, newContent: content };
                    const res = await fetch('/api/save-event-data', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                    if (!res.ok) throw new Error(await res.text());
                    alert('Saved successfully');
                } catch (err) {
                    alert('Save failed: ' + err.message);
                }
            }

            document.getElementById('load-file').addEventListener('click', (e) => {
                e.preventDefault();
                const sel = document.getElementById('file-select');
                loadFile(sel.value);
            });

            document.getElementById('save-file').addEventListener('click', (e) => {
                e.preventDefault();
                const sel = document.getElementById('file-select');
                const content = document.getElementById('event-raw').value;
                saveFile(sel.value, content);
            });

            document.getElementById('apply-header').addEventListener('click', (e) => {
                e.preventDefault();
                const parsedText = document.getElementById('parsed-header').textContent;
                try {
                    const parsed = JSON.parse(parsedText);
                    // Build a simple header from parsed KV
                    let headerLines = [];
                    for (const k of Object.keys(parsed)) {
                        headerLines.push(`${k}=${parsed[k]}`);
                    }
                    const headerBlock = headerLines.join('\n');
                    // Replace existing top-of-file header in raw
                    const raw = document.getElementById('event-raw').value;
                    const parts = raw.split(/(\r?\n){2,}/);
                    if (parts.length > 1) {
                        document.getElementById('event-raw').value = headerBlock + '\n\n' + parts.slice(1).join('');
                    } else {
                        document.getElementById('event-raw').value = headerBlock + '\n\n' + raw;
                    }
                    alert('Applied header to raw content. Review then click Save.');
                } catch (err) {
                    alert('Parsed header must be valid JSON to apply.');
                }
            });

            document.getElementById('save-as').addEventListener('click', async (e) => {
                e.preventDefault();
                const name = prompt('Enter filename to save as (e.g. CustomEvent.xml)');
                if (!name) return;
                const content = document.getElementById('event-raw').value;
                await saveFile(name, content);
                await loadOverview();
            });

            function parsePreview(fileDetails) {
                const preview = {};
                for (const f of fileDetails) {
                    preview[f.filename] = f.parsed || {};
                }
                return preview;
            }

            document.getElementById('new-event').addEventListener('click', async (e) => {
                e.preventDefault();
                // Append a simple Event.ini skeleton
                const skeleton = `; New Event Entry\n; Format: Type,Start,Repeat,Map:MonsterID:Count\n\n[Event]\nType=custom\nStart=00:00\nRepeat=once\n`;
                const existing = document.getElementById('event-raw').value || '';
                document.getElementById('event-raw').value = existing + '\n' + skeleton;
            });

            // initial load
            loadOverview();
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Event Scheduler - Editor</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@500&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <div class="container glass-effect">
        <header class="header">
            <h1><i data-lucide="calendar-clock"></i> Event Scheduler</h1>
            <p>Schedule and configure recurring server events for MuOnline Season 19.</p>
        </header>

        <main class="editor-grid">
            <section class="panel">
                <h2>Event List</h2>
                <p>Load, create, and edit scheduled events. Events reference data files under `data/Event/` and `data/` maps.</p>
                <div id="event-list" class="list">
                    <!-- Event rows will be populated by client JS -->
                </div>
                <div class="panel-actions">
                    <button id="new-event">New Event</button>
                    <button id="save-events">Save Changes</button>
                </div>
            </section>

            <section class="panel">
                <h2>Event Details</h2>
                <form id="event-form">
                    <label>Event Type
                        <select id="event-type">
                            <option value="blood_castle">Blood Castle</option>
                            <option value="devil_square">Devil Square</option>
                            <option value="invasion">Invasion</option>
                            <option value="castle_siege">Castle Siege</option>
                        </select>
                    </label>
                    <label>Start Time
                        <input type="time" id="event-start" />
                    </label>
                    <label>Repeat
                        <select id="event-repeat">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="once">Once</option>
                        </select>
                    </label>
                    <label>Maps / Monsters
                        <textarea id="event-monsters" rows="6" placeholder="MapID:MonsterID:Count, one per line"></textarea>
                    </label>
                </form>
            </section>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            // Basic client-side stub: fetch existing event definitions from server
            async function load() {
                try {
                    const res = await fetch('/api/event-data');
                    if (!res.ok) return;
                    const data = await res.json();
                    // populate event list (simple representation)
                    const list = document.getElementById('event-list');
                    list.innerHTML = '';
                    (data.events || []).forEach((ev, i) => {
                        const row = document.createElement('div');
                        row.className = 'list-row';
                        row.textContent = `${ev.type} — ${ev.start} — ${ev.repeat}`;
                        row.dataset.index = i;
                        list.appendChild(row);
                    });
                } catch (err) {
                    console.warn('Could not load event data', err);
                }
            }
            load();
        });
    </script>
</body>
</html>
